# HighloadArchitectureCourseWork

## 1. Выбор темы
Аналог современной торговой биржи, например [Московская биржа](https://www.moex.com/) или [Nasdaq](https://www.nasdaq.com/)

##  2.  Определение возможного диапазона нагрузок

Рассмотрим особенности расчета нагрузки на биржу. Основная нагрузка идет на бирже на торгово-клиринговую систему (ТКС), через которую проходят транзакции, заявки и сделки.
 
Можно сделать вывод, что если мы рассмотрим нагрузки на ТКС валютного, фондового и срочного рынка, то тем самым рассмотрим основную нагрузку на биржу. 

В качестве аналога, относительно которого будем рассматривать нагрузку - Московская Биржа. Особенность биржи в том, что часть данных о нагрузке и отказоустойчивости есть в открытом доступе, так как это важно для привлечения клиентов. 

Для определения возможного диапазона нагрузок и дальнейших расчетов воспользуемся следующими материалами:
- [Результаты нагрузочного тестирования московской биржи в от 30 марта 2019 года](https://www.moex.com/n23621/?nt=0)

### Нагрузка на ТКС фондового рынка

![](./media/ТКС_ФР.png)

![](./media/ТКС_ФР_График.png)	

Участвовало 14 банков

### Нагрузка на ТКС валютного рынка

![](./media/ТКС_ВР.png)

![](./media/ТКС_ВР_График.png)

Участвовало 18 банков

### Нагрузка на ТКС срочного рынка

![](./media/ТКС_СР.png)

![](./media/ТКС_СР_График.png)

Участвовало 15 банков

### Следовательно суммарная нагрузка на биржу за 2.5 часа нагрузочного тестирования

В день:

|Транзакции|Заявки|Сделки|
|----------|------|------|
|522 058 763|269 974 995|9 368 033|

В секунду:

|Транзакции|Заявки|Сделки|
|----------|------|------|
|299 720|66 355|4 474|

##### Примечание: 

 В отчете о нагрузочном тестировании оговаривается то, что реальная нагрузка в боевых условиях ниже, чем та, что была представлена в нагрузочном тестировании

## 3. Выбор планируемой нагрузки
Будем считать, что нагрузка на биржу от каждого клиента в среднем одинакова. 

В среднем при оценке нагрузки участвовало 16 банков. Следовательно с одного клиента приходилась нагрузка:

В секунду:

|Транзакции|Заявки|Сделки|
|----------|------|------|
|18 732,5|4 147,19|279,625|

Исходя из тех же результатов нагрузочного тестирования, по итогам рекомендуется использовать для обычного протокола канал в 10 Мбит/с 

Зная нагрузку в секунду посчитаем приблизительный размер пакета:

```
(10 x 1024 x 1024) / (18 732,5 + 4 147,19 + 279,625) ~ 450 бит
```

Будем расчитывать на нагрузку для [100 крупнейших банков Европы](https://www.invest-rating.ru/financial-forecasts/?id=7903)
Тогда нагрузка в секунду будет:

|Транзакции|Заявки|Сделки|
|----------|------|------|
|1 873 250|414 719|27 962,5| 


```
(1 873 250 + 414 719 + 27 962,5) x 450 = 1 042 169 175 бит/с = 1,04 Гбит/с
```

Исходя из [данных](https://www.moex.com/s223) максимальное время торгов 14 часов 20 минут (860 минут), тогда нагрузка в день со всех клиентов считается по формуле: 

```
(Нагрузка в секунду) * 860 * 60

 1,04 Гбит/с * 860 * 60 = 53 664 Гбит
 ```
 
## 4. Логическая схема Базы Данных
![](./media/ExhangeDB.png)

## 5. Физические системы хранения
Выделим основные особенности нагрузки на СУБД Биржи: 
- Часто пишем
- Часто читаем
- Данные нельзя потерять
- Задержка должна быть минимальной

Так как мы часто пишем и читаем - нам подойдет обычная SQL СУБД. Возьмем Postgres 12, так как она хорошо поддерживается сообществом и имеет хороший встроенный механизм репликации. 

В случае биржи мы имеем 3 типа запросов - Транзакции, Заказы и Сделки. Следовательно в нашем случае будет логичнее сделать вертикальный шардинг по этим трем сущностям.

Внутри каждого вертикального шарда есть смысл сделать горизонтальный шардинг для возможности без потери скорости хранить большое количество данных.

Ото всех клиентов нагрузка будет (из таблицы транзакции, сделки и заказы в секунду): 

```
1 873 250 + 414 719 + 27 962,5 = 2 315 931,5 RPS
```

Пусть в среднем на один сервер будет приходиться 2000 RPS, тогда нам понадобиться: 

```
2 315 931,5 RPS / 2000 RPS = 1158
```

1158 серверов с Postgers 12

